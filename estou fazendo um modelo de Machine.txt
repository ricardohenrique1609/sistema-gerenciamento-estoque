

SELECT 
    -- Níveis hierárquicos para o menu
    nome_completo_departamento_hierarquia_4 AS H5_Superintendencia,
    nome_completo_departamento_hierarquia_5 AS H6_Gerencia,
    
    -- Localização
    descricao_polo_administrativo AS Polo,
    descricao_local_departamento AS Local_Completo,
    
    -- CONTAGEM CORRETA: Conta quantos RACFs únicos existem na ÚLTIMA LISTA DISPONÍVEL
    COUNT(DISTINCT codigo_racf) AS Total_Oficial

FROM 
    db_corp_rh_analyticsapreports_spec_01.hub_people_analytics_colaborador

WHERE 
    texto_cidade_local_departamento = 'SAO PAULO'
    AND situacao_colaborador = 'ATIVO' -- Garante que é funcionário ativo
    
    -- !!! O TRUQUE: Pega apenas a lista mais recente do sistema !!!
    AND data_referencia = (
        SELECT MAX(data_referencia) 
        FROM db_corp_rh_analyticsapreports_spec_01.hub_people_analytics_colaborador
    )
    
    -- Seus filtros de prédio
    AND (
        descricao_polo_administrativo LIKE '%ACO%' OR
        descricao_polo_administrativo LIKE '%TECNOLOGICO%' OR
        descricao_polo_administrativo LIKE '%3400%' OR
        descricao_polo_administrativo LIKE '%3500%' OR
        descricao_local_departamento LIKE '%CONCEICAO%' OR
        descricao_local_departamento LIKE '%JABAQUARA%' OR
        descricao_local_departamento LIKE '%ALFREDO EGYDIO%' OR
        descricao_local_departamento LIKE '%WALTER MOREIRA%' OR
        descricao_local_departamento LIKE '%OLAVO SETUBAL%' OR
        descricao_local_departamento LIKE '%EUDORO VILLELA%'
    )

GROUP BY 
    nome_completo_departamento_hierarquia_4,
    nome_completo_departamento_hierarquia_5,
    descricao_polo_administrativo,
    descricao_local_departamento;
