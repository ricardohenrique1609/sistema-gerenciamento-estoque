SELECT 
    -- Níveis Hierárquicos
    nome_completo_departamento_hierarquia_4 AS h5_superintendencia,
    nome_completo_departamento_hierarquia_5 AS h6_gerencia,
    
    -- Localização
    descricao_polo_administrativo AS polo,
    descricao_local_departamento AS local_completo,
    
    -- Contagem (Headcount Único Ativo HOJE)
    COUNT(DISTINCT codigo_racf) AS total_oficial

FROM 
    db_corp_rh_analyticsapreports_spec_01.hub_people_analytics_colaborador

WHERE 
    texto_cidade_local_departamento = 'SAO PAULO'
    AND situacao_colaborador = 'ATIVO'
    
    -- !!! FILTRO CRUCIAL: PEGA APENAS A FOTO MAIS RECENTE !!!
    AND data_referencia = (
        SELECT MAX(data_referencia) 
        FROM db_corp_rh_analyticsapreports_spec_01.hub_people_analytics_colaborador
    )

    -- !!! FILTRO DE EXCLUSÃO (LIMPEZA) !!!
    AND UPPER(descricao_polo_administrativo) NOT LIKE '%WTORRE%'
    AND UPPER(descricao_predio_administrativo) NOT LIKE '%WTORRE%'
    AND UPPER(descricao_local_departamento) NOT LIKE '%WTORRE%'
    
    -- SEUS FILTROS DE PRÉDIOS (MANTIDOS)
    AND (
        UPPER(descricao_polo_administrativo) LIKE '%ACO%' OR
        UPPER(descricao_polo_administrativo) LIKE '%TECNOLOGICO%' OR
        UPPER(descricao_polo_administrativo) LIKE '%3400%' OR
        UPPER(descricao_polo_administrativo) LIKE '%3500%' OR
        UPPER(descricao_local_departamento) LIKE '%CONCEICAO%' OR
        UPPER(descricao_local_departamento) LIKE '%JABAQUARA%' OR
        UPPER(descricao_local_departamento) LIKE '%ALFREDO EGYDIO%' OR
        UPPER(descricao_local_departamento) LIKE '%WALTER MOREIRA%' OR
        UPPER(descricao_local_departamento) LIKE '%OLAVO SETUBAL%' OR
        UPPER(descricao_local_departamento) LIKE '%EUDORO VILLELA%'
    )

GROUP BY 
    nome_completo_departamento_hierarquia_4,
    nome_completo_departamento_hierarquia_5,
    descricao_polo_administrativo,
    descricao_local_departamento;
